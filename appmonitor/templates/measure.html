{% extends "base_layout.html" %}
{% load l10n %}

{% block title %}Måling '{{ testsuite.name }}' - '{{ mname }}'{% endblock %}

{% block breadcrumbs %}
    <li><a href="{% url 'appmonitor:testsuite' testsuite.pk %}">{{ testsuite.name }}</a></li>
    <li>Måling '{{ mname }}'</li>
{% endblock %}


{% block content %}
<h1>Måling '{{ testsuite.name }}' - '{{ mname }}'</h1>
<div>
    <form action="" method="get">
        <div>
            <label for="target_input">Målsætning:</label>
            <div>
                {% if measureconfig.failure_threshold %}
                {{ measureconfig.failure_threshold }} sekunder
                {% else %}
                Ikke angivet
                {% endif %}
                <a href="{% url 'admin:appmonitor_testmeasureconfig_change' measureconfig.pk %}" onclick="this.target='_blank'" class="btn btn-primary btn-xs">Rediger <span class="glyphicon glyphicon-new-window"></span></a>
            </div>
        </div>
        <h3>Referencemåling:</h3>
        <div>
            <label for="from">Fra:</label>
            <input id="from" class="datepicker" data-provide="datepicker">
            <label for="to">Til:</label>
            <input id="to" class="datepicker" data-provide="datepicker">
            <!--<select id="days" name="days">-->
                <!--<option {% if days == '1' %}selected="selected"{% endif %} value="1">Seneste døgn</option>-->
                <!--<option {% if days == '3' %}selected="selected"{% endif %} value="3">Seneste 3 døgn</option>-->
                <!--<option {% if days == '7' %}selected="selected"{% endif %} value="7">Seneste uge</option>-->
                <!--<option {% if days == '30' %}selected="selected"{% endif %} value="30">Sidste måned</option>-->
            <!--</select>-->
        </div>
        <div>
            <label for="cmp_ts">Testsuite:</label>
            <select id="cmp_ts" name="cmp_ts" data-selected="{{ request.GET.cmp_ts}}">
                <option value="">[Vælg testsuite]</option>
                {% for ts in cmp_data %}
                <option value="{{ ts.pk }}">{{ ts.name }}</option>
                {% endfor %}
            </select>
            <label for="cmp_measure">Måling:</label>
            <select id="cmp_measure" name="cmp" data-selected="{{ request.GET.cmp|safe }}">
            </select>
        </div>
        <input type="hidden" name="from" value="{{from}}" />
        <input type="hidden" name="to" value="{{to}}" />
        <input type="submit" value="Opdater" />
    </form>
</div>
<p>
    Klik på billedet for at åbne fuldskærms visning.
</p>
<div id="measureimage" class="">
    <div class="fullscreen-controls btn-group" role="group">
        <button class="btn btn-primary btn-sm">
            <span class="glyphicon glyphicon-refresh"></span>
            Opdatér
        </button>
        <button class="btn btn-success btn-sm">
            <span class="glyphicon glyphicon-ok-circle"></span>
            Afblæs alarm
        </button>
        <button class="btn btn-primary btn-sm">
            <span class="glyphicon glyphicon-remove"></span>
            Luk
        </button>
    </div>
    <img src="{% url 'appmonitor:png' testsuite.pk mname %}?{{ qstring_copy }}"
         width="100%" />
</div>
{% endblock %}
{% block bodyend_scripts %}
<script type="text/javascript"><!--
(function($) {
    var cmp_data = {{ cmp_data_json|safe }};
    var cmp_map = {}
    $.each(cmp_data, function() {
        cmp_map[this.pk] = this.items;
    });
    $("#cmp_ts").on("change", function() {
        var $this = $(this), new_val = $this.val(),
            mselect = $('#cmp_measure').get(0),
            opts = mselect.options;

        // Clear existing values
        while(opts.length > 0)
            opts[0] = null;
        if (new_val == "") {
            opts[opts.length] = new Option("[Vælg testsuite først]", "")
        } else {
            opts[opts.length] = new Option("[Vælg måling]", "")
            $.each(cmp_map[new_val], function() {
                opts[opts.length] = new Option(
                    this.replace(/^.+\//, ""), escape(this)
                );
            });
        }
    });
    $(function() {
        $("#cmp_ts").val($("#cmp_ts").attr("data-selected"));
        $("#cmp_ts").trigger("change");
        $("#cmp_measure").val($("#cmp_measure").attr("data-selected"));
    });
    
    var $div = $('#measureimage'),
        $img = $('#measureimage img').first();
    function toggle_fullscreen() {
        var src = $img.attr("src"),
            src_parts,
            new_qstring = [];

        $div.toggleClass('fullscreen');
        $div.removeClass('loaded');

        //split src into url and querystring
        src_parts = src.split("?", 2);
        if (!src_parts[1]) {
            src_parts[1] = ''
        }

        // Filter out xsize and ysize args
        $.each(src_parts[1].split("&"), function() {
            if (this && !this.match(/^((x|y)size|ts|fs)=/)) {
                new_qstring.push(this)
            }
        });

        // Add timestamp to avoid cache
        new_qstring.push("ts=" + parseInt(new Date().getTime()/1000.0))
        
        // Add new size args if switching to fullscreen
        if ($div.hasClass('fullscreen')) {
            new_qstring.push("xsize=" + $div.width());
            new_qstring.push("ysize=" + $div.height());
            new_qstring.push("fs=1");
        }

        // rebuild the src
        src_parts[1] = new_qstring.join("&")
        $img.attr("src", src_parts.join("?"));

    }
    $img.on('click', toggle_fullscreen)
    $img.on('load', function() {
        if ($div.hasClass('fullscreen') && !$div.hasClass('loaded')) {
            $div.addClass('loaded');
        }
    });
    $('.datepicker').datepicker({
        language: 'da',
        format: "dd-mm-yyyy",
    }).on('changeDate', function(e){
        $(this).datepicker('hide');
    });
})(jQuery)
//--></script>
{% endblock %}
